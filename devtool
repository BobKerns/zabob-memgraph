#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.12"
# dependencies = [
#     "click>=8.3.1",
#     "gitpython>=3.1.46",
#     "ruff>=0.14.14",
#     "mypy>=1.19.1",
#     "requests>=2.32.5",
#     "rich>=14.3.1",
#     "fastapi",
#     "uvicorn>=0.40.0",
#     "mcp>=1.26.0",
#     "fastmcp>=3.0.0b1",
#     "pydantic>=2.12.5",
#     "jinja2>=3.1.6",
#     "psutil>=7.2.2",
#     "pytest>=9.0.2",
#     "pytest-xdist>=3.8.0",
#     "pytest-asyncio>=1.3.0",
#     "anyio>=4.12.1",
#     "playwright>=1.57.0",
#    "pytest-playwright>=0.7.2",
# ]
# ///
"""
Zabob Memgraph - Development Tool.

Manages development tasks including dev-library integration.
"""

import sys
import time
from pathlib import Path

import click

project_root = Path(__file__).parent
# Add .dev-library to path
sys.path.insert(0, str(project_root / ".dev-library"))

from zabob.tools.libtools import cli, CONFIG  # noqa: E402
from memgraph.__main__ import cli as server   # noqa: E402

cli.add_command(server, name="server")

# Configure paths for check commands
CONFIG["paths"] = [
    project_root / "memgraph",
    project_root / "tests",
    *CONFIG["paths"]
]
CONFIG["config"] = str(project_root / "pyproject.toml")


@server.command()
@click.option("--url", default="http://localhost:6789", help="Server URL")
def test(url: str) -> None:
    """Test server endpoints and functionality."""
    import requests
    from rich.console import Console
    from rich.panel import Panel

    console = Console()
    console.print(Panel(f"Testing Memgraph Server at {url}", title="üß™ Server Test"))

    # Test health endpoint
    try:
        response = requests.get(f"{url}/health", timeout=5)
        if response.status_code == 200:
            health_data = response.json()
            console.print("‚úÖ Health check passed")
            console.print(f"   Version: {health_data.get('version', 'unknown')}")
            console.print(f"   Features: {', '.join(health_data.get('features', []))}")
        else:
            console.print(f"‚ùå Health check failed: {response.status_code}")
            return
    except requests.RequestException as e:
        console.print(f"‚ùå Could not connect to server: {e}")
        return

    # Test knowledge graph endpoint
    try:
        response = requests.get(f"{url}/api/knowledge-graph", timeout=10)
        if response.status_code == 200:
            graph_data = response.json()
            console.print("‚úÖ Knowledge graph endpoint working")
            console.print(f"   Entities: {len(graph_data.get('nodes', []))}")
            console.print(f"   Relations: {len(graph_data.get('links', []))}")
        else:
            console.print(f"‚ùå Knowledge graph failed: {response.status_code}")
    except requests.RequestException as e:
        console.print(f"‚ùå Knowledge graph error: {e}")

    # Test search endpoint
    try:
        response = requests.get(f"{url}/api/search?q=test", timeout=5)
        if response.status_code == 200:
            search_results = response.json()
            console.print("‚úÖ Search endpoint working")
            console.print(f"   Results for 'test': {len(search_results)}")
        else:
            console.print(f"‚ùå Search failed: {response.status_code}")
    except requests.RequestException as e:
        console.print(f"‚ùå Search error: {e}")

    # Test entity creation
    test_entity = {
        "name": f"Test Entity {int(time.time())}",
        "entityType": "test",
        "observations": ["This is a test observation", "Created by dev script"],
    }

    try:
        response = requests.post(f"{url}/api/entities", json=[test_entity], timeout=5)
        if response.status_code == 200:
            console.print("‚úÖ Entity creation working")
        else:
            console.print(f"‚ùå Entity creation failed: {response.status_code}")
    except requests.RequestException as e:
        console.print(f"‚ùå Entity creation error: {e}")

    console.print("\nüéâ Server test complete!")


@server.command()
@click.option("--url", default="http://localhost:6789", help="Server URL")
def stats(url: str) -> None:
    """Display server statistics."""
    import requests
    from rich.console import Console
    from rich.table import Table

    console = Console()

    try:
        response = requests.get(f"{url}/api/database-stats", timeout=5)
        if response.status_code == 200:
            stats_data = response.json()

            table = Table(title="üìä Database Statistics")
            table.add_column("Metric", style="cyan")
            table.add_column("Value", style="green")

            table.add_row("Total Entities", str(stats_data.get("total_entities", "N/A")))
            table.add_row("Total Relations", str(stats_data.get("total_relations", "N/A")))
            table.add_row(
                "Database Size", f"{stats_data.get('database_size_mb', 0):.2f} MB"
            )
            table.add_row("Backend Type", stats_data.get("backend_type", "Unknown"))

            console.print(table)
        else:
            console.print(f"‚ùå Could not get stats: {response.status_code}")

    except requests.RequestException as e:
        console.print(f"‚ùå Stats error: {e}")


@server.command()
@click.option("--url", default="http://localhost:6789", help="Server URL")
@click.option("--interval", default=5, help="Check interval in seconds")
def monitor(url: str, interval: int) -> None:
    """Monitor server health continuously."""
    import requests
    from rich.console import Console
    from rich.panel import Panel
    from rich.progress import Progress, SpinnerColumn, TextColumn

    console = Console()
    console.print(
        Panel(f"Monitoring server at {url} (Ctrl+C to stop)", title="üì° Server Monitor")
    )

    try:
        while True:
            with Progress(
                SpinnerColumn(),
                TextColumn("[progress.description]{task.description}"),
                console=console,
                transient=True,
            ) as progress:
                task = progress.add_task("Checking server...", total=None)

                try:
                    response = requests.get(f"{url}/health", timeout=3)
                    if response.status_code == 200:
                        timestamp = time.strftime("%H:%M:%S")
                        health = response.json()
                        console.print(
                            f"[green]{timestamp}[/green] ‚úÖ Server healthy "
                            f"- {health.get('status', 'unknown')}"
                        )
                    else:
                        timestamp = time.strftime("%H:%M:%S")
                        console.print(
                            f"[red]{timestamp}[/red] ‚ùå Server unhealthy "
                            f"- HTTP {response.status_code}"
                        )

                except requests.RequestException:
                    timestamp = time.strftime("%H:%M:%S")
                    console.print(f"[red]{timestamp}[/red] ‚ùå Server unreachable")

                progress.remove_task(task)

            time.sleep(interval)

    except KeyboardInterrupt:
        console.print("\nüëã Monitoring stopped")


if __name__ == "__main__":
    cli()
