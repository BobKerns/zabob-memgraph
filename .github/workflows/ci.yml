name: CI

on:
  workflow_call:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6.0.1
      with:
        lfs: true

    - name: Free up disk space
      run: |
        echo "Initial disk space:"
        df -h
        # Remove large packages we don't need
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        sudo rm -rf /opt/ghc
        sudo rm -rf /opt/hostedtoolcache/CodeQL
        echo "Disk space after package removal:"
        df -h
        # Clean up Docker images
        sudo docker image prune --all --force
        echo "Disk space after Docker image prune:"
        df -h

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3.11.1

    - name: Build test image with caching
      uses: docker/build-push-action@v6.18.0
      with:
        context: .
        file: Dockerfile.test
        build-args: |
          BASE_IMAGE_REGISTRY=ghcr.io
          BASE_IMAGE_NAME=bobkerns/zabob-memgraph
          BASE_IMAGE_VERSION=v2
        tags: zabob-memgraph-test:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        load: true

    - name: Run all quality checks and tests
      run: docker run --rm zabob-memgraph-test:latest

    - name: Test dev utilities
      run: |
        docker run --rm zabob-memgraph-test:latest \
          uv run python dev_utils.py --help

    - name: Build final runtime image
      uses: docker/build-push-action@v6.18.0
      with:
        context: .
        file: Dockerfile
        build-args: |
          BASE_IMAGE_REGISTRY=ghcr.io
          BASE_IMAGE_NAME=bobkerns/zabob-memgraph
          BASE_IMAGE_VERSION=v2
        tags: zabob-memgraph:latest
        cache-from: type=gha
        load: true

    - name: Upload docker context artifact
      uses: actions/upload-artifact@v6
      with:
        name: docker-context
        path: .
        retention-days: 7

    - name: Extract web bundle from image
      run: |
        # Create container from test image to extract web bundle
        docker create --name temp-extract zabob-memgraph-test:latest
        docker cp temp-extract:/app/memgraph/web ./memgraph/
        docker rm temp-extract

    - name: Upload web artifact
      uses: actions/upload-artifact@v6
      with:
        name: web
        path: memgraph/web
        retention-days: 7

    - name: Build Python package
      run: |
        # Install uv for package building
        curl -LsSf https://astral.sh/uv/install.sh | sh
        source $HOME/.cargo/env
        uv build

    - name: Upload python artifact
      uses: actions/upload-artifact@v6
      with:
        name: python-package-distributions
        path: dist/
        retention-days: 7

