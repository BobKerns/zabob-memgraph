name: Publish DockerHub

on:
  workflow_call:
    inputs:
      image-tag:
        description: 'Image tag to pull from GHCR'
        required: true
        type: string

env:
  REGISTRY_GHCR: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  publish-test:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/test-v')

    environment:
      name: dockerhub-test

    permissions:
      contents: read
      id-token: write  # Required for trusted publishing

    steps:
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3.7.0
      with:
        registry: ${{ env.REGISTRY_GHCR }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull from GHCR
      run: |
        IMAGE_NAME_LOWER="${{ env.IMAGE_NAME }}"
        IMAGE_NAME_LOWER="${IMAGE_NAME_LOWER,,}"
        docker pull ghcr.io/${IMAGE_NAME_LOWER}:${{ inputs.image-tag }}

    - name: Log in to DockerHub Test
      uses: docker/login-action@v3.7.0
      with:
        username: ${{ secrets.DOCKERHUB_TEST_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TEST_TOKEN }}

    - name: Tag and push to DockerHub Test
      run: |
        IMAGE_NAME_LOWER="${{ env.IMAGE_NAME }}"
        IMAGE_NAME_LOWER="${IMAGE_NAME_LOWER,,}"
        # Tag for test repository (no :latest)
        docker tag ghcr.io/${IMAGE_NAME_LOWER}:${{ inputs.image-tag }} \
          ${{ secrets.DOCKERHUB_TEST_USERNAME }}/zabob-memgraph-test:${{ github.ref_name }}

        # Push to test repository
        docker push ${{ secrets.DOCKERHUB_TEST_USERNAME }}/zabob-memgraph-test:${{ github.ref_name }}

    - name: Verify push to DockerHub Test
      run: |
        # Verify we can pull from test repository
        docker pull ${{ secrets.DOCKERHUB_TEST_USERNAME }}/zabob-memgraph-test:${{ github.ref_name }}
        echo "✓ Successfully pushed and verified image in test repository"

  publish-prod:
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    environment:
      name: dockerhub

    permissions:
      contents: read
      id-token: write  # Required for trusted publishing

    steps:
    - name: Log in to GitHub Container Registry\
      uses: docker/login-action@v3.7.0
      with:
        registry: ${{ env.REGISTRY_GHCR }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull from GHCR
      run: |
        IMAGE_NAME_LOWER="${{ env.IMAGE_NAME }}"
        IMAGE_NAME_LOWER="${IMAGE_NAME_LOWER,,}"
        docker pull ghcr.io/${IMAGE_NAME_LOWER}:${{ inputs.image-tag }}

    - name: Log in to DockerHub
      uses: docker/login-action@v3.7.0
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Tag and push to DockerHub
      run: |
        IMAGE_NAME_LOWER="${{ env.IMAGE_NAME }}"
        IMAGE_NAME_LOWER="${IMAGE_NAME_LOWER,,}"
        GHCR_IMAGE="ghcr.io/${IMAGE_NAME_LOWER}:${{ inputs.image-tag }}"

        # Extract version components
        VERSION="${{ github.ref_name }}"
        VERSION="${VERSION#v}"  # Remove 'v' prefix
        MAJOR="${VERSION%%.*}"
        MINOR="${VERSION#*.}"
        MINOR="${MINOR%%.*}"

        # Tag for production repository
        docker tag "$GHCR_IMAGE" \
          ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:${VERSION}
        docker tag "$GHCR_IMAGE" \
          ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:${MAJOR}.${MINOR}
        docker tag "$GHCR_IMAGE" \
          ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:latest

        # Push all tags
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:${VERSION}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:${MAJOR}.${MINOR}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:latest

    - name: Verify push to DockerHub
      run: |
        # Verify we can pull from production repository
        docker pull ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:latest
        echo "✓ Successfully pushed and verified image in production repository"
