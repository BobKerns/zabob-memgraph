name: Publish DockerHub

on:
  workflow_run:
    workflows: ["Build Docker"]
    types: [completed]

env:
  REGISTRY_GHCR: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  publish-test:
    runs-on: ubuntu-latest
    if: |
      startsWith(github.ref, 'refs/tags/test-v') &&
      (github.event.workflow_run.conclusion == 'success')

    environment:
      name: dockerhub-test

    steps:
    - name: Get Dockerfile
      uses: actions/download-artifact@v7
      with:
          name: dockerfile
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3.6.0
      with:
        registry: ${{ env.REGISTRY_GHCR }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull from GHCR
      run: |
        docker pull ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

    - name: Log in to DockerHub Test
      uses: docker/login-action@v3.6.0
      with:
        username: ${{ secrets.DOCKERHUB_TEST_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TEST_TOKEN }}

    - name: Tag and push to DockerHub Test
      run: |
        # Tag for test repository (no :latest)
        docker tag ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }} \
          ${{ secrets.DOCKERHUB_TEST_USERNAME }}/zabob-memgraph-test:${{ github.ref_name }}

        # Push to test repository
        docker push ${{ secrets.DOCKERHUB_TEST_USERNAME }}/zabob-memgraph-test:${{ github.ref_name }}

    - name: Verify push to DockerHub Test
      run: |
        # Verify we can pull from test repository
        docker pull ${{ secrets.DOCKERHUB_TEST_USERNAME }}/zabob-memgraph-test:${{ github.ref_name }}
        echo "✓ Successfully pushed and verified image in test repository"

  publish-prod:
    runs-on: ubuntu-latest
    if: |
      startsWith(github.ref, 'refs/tags/v') &&
      (github.event_name == 'push' || github.event.workflow_run.conclusion == 'success')

    environment:
      name: dockerhub

    steps:
    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3.6.0
      with:
        registry: ${{ env.REGISTRY_GHCR }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Pull from GHCR
      run: |
        docker pull ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

    - name: Log in to DockerHub
      uses: docker/login-action@v3.6.0
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Tag and push to DockerHub
      run: |
        # Extract version components
        VERSION="${{ github.ref_name }}"
        VERSION="${VERSION#v}"  # Remove 'v' prefix
        MAJOR="${VERSION%%.*}"
        MINOR="${VERSION#*.}"
        MINOR="${MINOR%%.*}"

        # Tag for production repository
        docker tag ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }} \
          ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:${VERSION}
        docker tag ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }} \
          ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:${MAJOR}.${MINOR}
        docker tag ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }} \
          ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:latest

        # Push all tags
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:${VERSION}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:${MAJOR}.${MINOR}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:latest

    - name: Verify push to DockerHub
      run: |
        # Verify we can pull from production repository
        docker pull ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:latest
        echo "✓ Successfully pushed and verified image in production repository"
