name: Publish DockerHub

on:
  workflow_run:
    workflows: ["Build Docker"]
    types: [completed]
  push:
    tags:
      - 'test-v*'  # Test releases
      - 'v*'       # Production releases

env:
  REGISTRY_GHCR: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  publish-test:
    runs-on: ubuntu-latest
    if: |
      startsWith(github.ref, 'refs/tags/test-v') &&
      (github.event_name == 'push' || github.event.workflow_run.conclusion == 'success')

    environment:
      name: dockerhub-test

    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_GHCR }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Log in to DockerHub Test
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_TEST_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TEST_TOKEN }}

    - name: Pull from GHCR
      run: |
        docker pull ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

    - name: Tag and push to DockerHub Test
      run: |
        # Tag for test repository (no :latest)
        docker tag ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }} \
          ${{ secrets.DOCKERHUB_TEST_USERNAME }}/zabob-memgraph-test:${{ github.ref_name }}
        
        # Push to test repository
        docker push ${{ secrets.DOCKERHUB_TEST_USERNAME }}/zabob-memgraph-test:${{ github.ref_name }}

    - name: Test Docker image from DockerHub Test
      run: |
        # Pull from test repository
        docker pull ${{ secrets.DOCKERHUB_TEST_USERNAME }}/zabob-memgraph-test:${{ github.ref_name }}

        # Run container
        docker run -d --name test-memgraph -p 6789:8080 \
          ${{ secrets.DOCKERHUB_TEST_USERNAME }}/zabob-memgraph-test:${{ github.ref_name }}

        # Wait for startup
        sleep 10

        # Test health endpoint
        curl -f http://localhost:6789/health || exit 1

        # Test web UI
        curl -f http://localhost:6789/ || exit 1

        # Show logs
        docker logs test-memgraph

        # Cleanup
        docker stop test-memgraph
        docker rm test-memgraph

  publish-prod:
    runs-on: ubuntu-latest
    if: |
      startsWith(github.ref, 'refs/tags/v') &&
      !startsWith(github.ref, 'refs/tags/test-v') &&
      (github.event_name == 'push' || github.event.workflow_run.conclusion == 'success')

    environment:
      name: dockerhub

    steps:
    - uses: actions/checkout@v4
      with:
        lfs: true

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY_GHCR }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Log in to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Pull from GHCR
      run: |
        docker pull ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

    - name: Tag and push to DockerHub
      run: |
        # Extract version components
        VERSION="${{ github.ref_name }}"
        VERSION="${VERSION#v}"  # Remove 'v' prefix
        MAJOR="${VERSION%%.*}"
        MINOR="${VERSION#*.}"
        MINOR="${MINOR%%.*}"

        # Tag for production repository
        docker tag ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }} \
          ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:${VERSION}
        docker tag ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }} \
          ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:${MAJOR}.${MINOR}
        docker tag ${{ env.REGISTRY_GHCR }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }} \
          ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:latest
        
        # Push all tags
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:${VERSION}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:${MAJOR}.${MINOR}
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:latest

    - name: Test Docker image from DockerHub
      run: |
        # Pull from production repository
        docker pull ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:latest

        # Run container
        docker run -d --name test-memgraph -p 6789:8080 \
          ${{ secrets.DOCKERHUB_USERNAME }}/zabob-memgraph:latest

        # Wait for startup
        sleep 10

        # Test health endpoint
        curl -f http://localhost:6789/health || exit 1

        # Test web UI
        curl -f http://localhost:6789/ || exit 1

        # Show logs
        docker logs test-memgraph

        # Cleanup
        docker stop test-memgraph
        docker rm test-memgraph
