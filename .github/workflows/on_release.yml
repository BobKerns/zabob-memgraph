name: Release

on:
    push:
        tags:
          - v*
          - test-v*

permissions:
    contents: read
    packages: write
    id-token: write

jobs:
  build_python_package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Install pnpm
        uses: pnpm/action-setup@v4.2.0

      - name: Set up Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: '24'
          cache: 'pnpm'

      - name: Build web bundle
        run: |
          pnpm install
          pnpm run build:web

      - name: Install uv
        uses: astral-sh/setup-uv@v7.2.0

      - name: Set up Python
        run: uv python install

      - name: Build Python package
        run: uv build

      - name: Upload python artifact
        uses: actions/upload-artifact@v6
        with:
          name: python-package-distributions
          path: dist/
          retention-days: 7

  retag_docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-name: ${{ steps.setup.outputs.image-name }}
    steps:
      - uses: actions/checkout@v6.0.1

      - name: Set up image name and tree SHA
        id: setup
        run: |
          IMAGE_NAME="${{ github.repository }}"
          IMAGE_NAME_LOWER="${IMAGE_NAME,,}"
          TREE_SHA=$(git rev-parse HEAD^{tree})
          echo "image-name=$IMAGE_NAME_LOWER" >> $GITHUB_OUTPUT
          echo "tree-sha=$TREE_SHA" >> $GITHUB_OUTPUT
          echo "Image: ghcr.io/$IMAGE_NAME_LOWER"
          echo "Tree SHA: $TREE_SHA"
          echo "Release tag: ${{ github.ref_name }}"

      - name: Log in to GHCR
        uses: docker/login-action@v3.7.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      - name: Pull image by tree SHA and create release tags
        run: |
          TREE_SHA="${{ steps.setup.outputs.tree-sha }}"
          IMAGE="ghcr.io/${{ steps.setup.outputs.image-name }}"
          RELEASE_TAG="${{ github.ref_name }}"

          # The multi-arch manifest was already created with tree SHA in docker-build.yml
          # Just re-tag it with the release version
          docker buildx imagetools create \
            -t "$IMAGE:$RELEASE_TAG" \
            -t "$IMAGE:latest" \
            "$IMAGE:tree-${TREE_SHA}"

          echo "âœ“ Created release tags: $IMAGE:$RELEASE_TAG and $IMAGE:latest"

      - name: Verify manifest
        run: |
          docker buildx imagetools inspect ghcr.io/${{ steps.setup.outputs.image-name }}:${{ github.ref_name }}

  publish_pypi_test:
    needs:
      - build_python_package
      - retag_docker
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/test-v')

    permissions:
      contents: read
      id-token: write  # Required for trusted publishing

    environment:
      name: testpypi
      url: https://test.pypi.org/p/zabob-memgraph

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v7
      with:
        name: python-package-distributions
        path: dist/

    - name: Publish to TestPyPI
      uses: pypa/gh-action-pypi-publish@release/v1.13
      with:
        repository-url: https://test.pypi.org/legacy/
        print-hash: true

  publish_pypi_prod:
    needs:
      - build_python_package
      - retag_docker
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') && !startsWith(github.ref, 'refs/tags/test-v')

    permissions:
      contents: read
      id-token: write  # Required for trusted publishing

    environment:
      name: pypi
      url: https://pypi.org/p/zabob-memgraph

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v7
      with:
        name: python-package-distributions
        path: dist/

    - name: Publish to PyPI
      uses: pypa/gh-action-pypi-publish@release/v1.13
      with:
        print-hash: true

  publish_dockerhub:
    needs: retag_docker
    uses: ./.github/workflows/dockerhub.yml
    with:
      image-tag: ${{ github.ref_name }}
    secrets: inherit

  create-release:
    needs:
      - publish_dockerhub
      - publish_pypi_test
      - publish_pypi_prod
    if: |
      always() &&
      needs.publish_dockerhub.result == 'success' &&
      ((needs.publish_pypi_test.result == 'success' && needs.publish_pypi_prod.result == 'skipped')||
       (needs.publish_pypi_test.result == 'skipped' && needs.publish_pypi_prod.result == 'success'))
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Create GitHub Release
      uses: actions/create-release@v1.1.4
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        prerelease: ${{ startsWith(github.ref_name, 'test-') }}
        body: |
          ## Zabob Memgraph ${{ github.ref_name }}

          ### Installation

          ```bash
          pip install zabob-memgraph
          ```

          Or with Docker:

          ```bash
          docker pull bobkerns/zabob-memgraph:${{ github.ref_name }}
          ```

          ### Links

          - [PyPI Package](https://pypi.org/project/zabob-memgraph/${{ github.ref_name }}/)
          - [Docker Image (DockerHub)](https://hub.docker.com/r/bobkerns/zabob-memgraph)
          - [Docker Image (GHCR)](https://github.com/BobKerns/zabob-memgraph/pkgs/container/zabob-memgraph)

          ### What's Changed

          See [CHANGELOG.md](https://github.com/BobKerns/zabob-memgraph/blob/main/CHANGELOG.md) for details.
        draft: false
