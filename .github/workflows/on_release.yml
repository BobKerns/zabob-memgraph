name: Release

on:
    push:
        tags:
          - 'v*'
          - 'test-v*'

permissions:
    contents: read
    packages: write

jobs:
  build_and_test:
    uses: ./.github/workflows/ci.yml

  build_docker:
    needs: build_and_test
    uses: ./.github/workflows/docker-build.yml

  publish_pypi:
    needs: build_and_test
    uses: ./.github/workflows/pypi.yml

  publish_dockerhub:
    needs: build_docker
    uses: ./.github/workflows/dockerhub.yml

  create-release:
    needs:
      - publish_pypi
      - publish_dockerhub
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
    - name: Create GitHub Release
      uses: actions/create-release@v1.1.4
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        body: |
          ## Zabob Memgraph ${{ github.ref_name }}

          ### Installation

          ```bash
          pip install zabob-memgraph
          ```

          Or with Docker:

          ```bash
          docker pull bobkerns/zabob-memgraph:${{ github.ref_name }}
          ```

          ### Links

          - [PyPI Package](https://pypi.org/project/zabob-memgraph/${{ github.ref_name }}/)
          - [Docker Image (DockerHub)](https://hub.docker.com/r/bobkerns/zabob-memgraph)
          - [Docker Image (GHCR)](https://github.com/BobKerns/zabob-memgraph/pkgs/container/zabob-memgraph)

          ### What's Changed

          See [CHANGELOG.md](https://github.com/BobKerns/zabob-memgraph/blob/main/CHANGELOG.md) for details.
        draft: false
        prerelease: false
